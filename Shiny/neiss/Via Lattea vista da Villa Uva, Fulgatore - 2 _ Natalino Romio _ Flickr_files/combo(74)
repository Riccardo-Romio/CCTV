YUI.add("flickr-route",(function(r,e){var t=require("hermes-core/flog")(e),i=require("hermes-core/type-validator");r.Routes=r.Routes||{},r.FlickrRoute=function(r){this.appContext=r},r.FlickrRoute.prototype={run:function(){},setRouteDataOnHistory:function(e,t){return r.HistoryHelper.setData(this.name,e,t)},getRouteDataFromHistory:function(e){return r.HistoryHelper.getData(this.name,e)},getRouteMetaValue:function(r,e){return this.appContext.routeConfig.meta?e?this.appContext.routeConfig.meta[r]?this.appContext.routeConfig.meta[r]:e:this.appContext.routeConfig.meta[r]?this.appContext.routeConfig.meta[r]:null:null},displayServerErrorOrClientRedirect:function(e,t,i){return YUI.Env.isServer?this.displayRouteErrors(e,new r.RouteError(404,t)):r.Promise.resolve({redirect:i||e.url})},detectRouteErrors:function(){var e=r.Array(arguments);return e.filter((function(e,t){return e instanceof r.RouteError})).sort((function(r,e){return r.type-e.type}))},displayRouteErrors:function(e,t){var i=r.Lang.isArray(t)?t[0]:t;return r.Promise.resolve(this["display"+i.type+"Error"](e,i))},display500Error:function(e,i){var a,s,o;return a={view:"error-500-page-view",params:{},headers:{statusCode:500}},(r.config.flickr.error.show_debugging_info||e.isPossiblyAdminUser||this.appContext&&this.appContext.auth&&this.appContext.auth.isPossiblyAdminUser)&&(a.params.source="flickrRoute#display500Error",a.params.message=i.message,a.params.stack=i.stack,a.params.apiMethod=i.apiMethod),YUI.Env.isServer||(a.params.message=i.message,a.params.apiMethod=i.apiMethod),e.id&&(a.params.requestID=e.id),i&&"SiteAuth"===i.type&&(i.redirect?(s=YUI.Env.isServer?e.protocol+"://"+e.hostname+e.originalUrl:e.url,o=r.url("/siteauth/?redirect_url="+encodeURIComponent(s)),YUI.Env.isServer&&t.info("Redirecting to siteauth"),a={redirect:o}):YUI.Env.isServer&&(a.params.siteAuthFailure=!0)),void 0===a.redirect?t.info("render",{status:500,req:e,err:i,isBot:this.appContext.getUA().isBot}):t.info("redirect",{status:302,req:e,location:a.redirect,isBot:this.appContext.getUA().isBot}),a},display303Error:function(r,e){return{redirect:e.options.redirect,headers:{statusCode:303}}},display403Error:function(r,e){return this.displayStandardErrorPage(r,e,403)},display404Error:function(r,e){return e=e||new Error("404"),t.info("render",{status:404,url:r.url,err:e,isBot:this.appContext.getUA().isBot}),this.displayStandardErrorPage(r,e,404)},display410Error:function(r,e){return this.displayStandardErrorPage(r,e,410)},displayStandardErrorPage:function(e,t,i){var a;return t=t||{},a={view:"fluid-error-page-view",params:{statusCode:i,url:e.url,message:t.message,catchAll:t.catchAll||!1},headers:{statusCode:i}},t.data&&(a.params=r.merge(a.params,t.data)),(r.config.flickr.error.show_debugging_info||e.isPossiblyAdminUser||this.appContext&&this.appContext.auth&&this.appContext.auth.isPossiblyAdminUser)&&(a.params.source="flickrRoute#display"+i+"Error",a.params.message=t.message),e.id&&(a.params.requestID=e.id),a},getPageNumber:function(r,e){var t=parseInt(r.params[e||"page_number"],10);return(isNaN(t)||t<=1)&&(t=1),t},getNSIDOrPathAlias:function(r){var e;return i.nsid(r)?e=r:i.pathAlias(r)?e={pathAlias:r}:t.warn("Couldn't identify "+r+" as an nsid or path alias."),e}},r.RouteError=function(r,e,t){this.type=r,this.message=e||"",this.data=t||{}}}),"@VERSION@",{requires:["flickr-promise","moment","url","history-helper"],optionalRequires:["hermes-core"]});YUI.add("photostream-route",(function(e){var t=require("hermes-core/type-validator"),o=50,r=100,i="pu";function s(e){s.superclass.constructor.call(this,e)}e.Routes[this.name]=s,e.extend(s,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(s){var a,n,l,d=this,u=s.params.nsid_or_path_alias,p=!!s.headers&&s.headers["user-agent"],m=s.params&&s.params.photo_id,h=m?r:25,c=this.getPageNumber(s),g={},f=[],P=this.appContext.getViewer(),w=s.geo;p&&null!==p.match(/^Twitterbot/i)?this.isTwitterbot=!0:this.isTwitterbot=!1,this.isEdit=s.params&&s.params.edit,this.isCameraroll=s.query&&void 0!==s.query.cameraroll,this.showShareOnLoad=void 0!==s.query.share,n=this.isEdit?"/photos/"+u+"/edit/":"/photos/"+u+"/";var v=s.query&&""===s.query.helloPro||!1,R=s.query&&void 0!==s.query.giftPro;return(a={page:r/h*(c-1)+1,perPage:h,withPhotoId:m}).orderBy="use_pref",a.viewAs=d.isCameraroll?"me":"use_pref",a.createCompoundID=!m,t.nsid(u)?g.id=u:g.pathAlias=u,(P.signedIn||s.probableUser)&&(f.push(this.appContext.getModel("person-preferences-models",P.signedIn?P.nsid:s.probableUser)),f.push(this.appContext.getModel("person-contacts-count-models",g))),e.Promise.all(f).catch((function(e){if(e.getModelFailure&&s.probableUser)return s.probableUser=null,[];throw e})).then((function(p){var h,f,P,x=!!p[0]&&p[0],b=0,C={};return t.nsid(u)&&x&&(i=x.getValue("photostreamViewAsPref"),f=d.buildContextSuffix(x,u),g.id=u+"-"+f),d.appContext.getModel("photostream-models",g,a).then((function(p){if(P=p.getValue("owner").getValue("nsid"),YUI.Env.isServer&&(b=Math.ceil(p.getValue("totalItems")/r),c>b&&a.page>1&&!isNaN(parseInt(s.params.page_number,10))))return e.Promise.resolve({redirect:n.replace(/page[0-9]+/,"")});if(t.nsid(u)||(x?(i=x.getValue("photostreamViewAsPref"),f=d.buildContextSuffix(x,P),g.id=P+"-"+f):g.id=P),C.withPhotoId=m,C.contextSuffix=f,C.baseURL=n,C.isHelloPro=v,p.getValue("owner").getValue("isPro")&&(R=!1),C.openGiftPro=R,m){if(h=p.getValue("photoPageList"),-1===(l=h.getPageOf({id:m},o))||h.getNextIncompletePage(a)===l)return a.forceAPICall=!0,t.nsid(u)?a.id=u:a.pathAlias=u,h.getPage(a).then((function(e){return c=Math.ceil(h.getPageOf({id:m},o)*o/r),l=c,d.onRouteResolved(p,c,l,C,w)}),(function(t){return e.Promise.resolve({redirect:n})}));c=Math.ceil(h.getPageOf({id:m},o)*o/r),l=c}else l=2*(c-1)+1;return d.onRouteResolved(p,c,l,C,w)}),(function(t){return t&&m?e.Promise.resolve({redirect:n}):t.timeout?d.appContext.getModel("person-models",g).then((function(t){var o=t.getValue("displayname"),r={view:"empty-page-view",title:o,params:{geo:w,isSlow:!0,viewAs:d.isCameraroll?"me":i,page:"photostream",displayName:o,nsid:t.getValue("nsid"),isCamerarollPhotostream:d.isCameraroll}};return e.Promise.resolve(r)}),(function(){return d.onRouteRejected(t,s)})):d.onRouteRejected(t,s,n)}))})).catch((function(e){return d.onRouteRejected(e,s,n)}))},buildContextSuffix:function(t,o){return e.Models["person-preferences-models"].buildContextSuffix(t,o)},onRouteResolved:function(t,s,a,n,l){var d,u=t.getValue("totalItems"),p=t.getValue("owner").getValue("displayname"),m=t.getValue("owner").getValue("nsid"),h=this.appContext.getViewer(),c=!1;if(0===parseInt(u,10))d={view:"empty-page-view",title:p,params:{geo:l,isHelloPro:n.isHelloPro,openGiftPro:n.openGiftPro,displayName:p,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,viewAs:this.isCameraroll?"me":i,page:"photostream",isCamerarollPhotostream:this.isCameraroll}};else{if(c=h.signedIn&&h.nsid===m,this.isEdit&&!c)return e.Promise.resolve({redirect:n.baseURL.replace(/\/edit/,"")});d={view:this.isEdit?"photostream-edit-page-view":"photostream-page-view",title:p,params:{geo:l,isHelloPro:n.isHelloPro,openGiftPro:n.openGiftPro,nsid:e.Models["photostream-models"].splitCompoundId(t.id).nsid,withPhotoId:n.withPhotoId,isTwitterbot:this.isTwitterbot,contextId:m+"-"+n.contextSuffix,pageParams:{page:a,perPage:n.withPhotoId?r:o,viewPageSize:r,nominalPage:s,idAttribute:"contextId",createCompoundID:!n.withPhotoId},baseURL:n.baseURL,contextSuffix:n.contextSuffix,isCameraroll:this.isCameraroll,showShareOnLoad:this.showShareOnLoad}}}return e.Promise.resolve(d)},onRouteRejected:function(t,o,r){if(t.fatal)throw t;return 15===t.code?e.Promise.resolve({redirect:r}):5===t.code?this.displayRouteErrors(o,new e.RouteError(410,this.intlMessage({intlName:"common.404_PHOTOSTREAM_DELETED"}))):this.displayRouteErrors(o,new e.RouteError(404,this.intlMessage({intlName:"common.404_PHOTOSTREAM_NONEXISTENT"})))}}),e.mix(s.prototype,e.Localizable)}),"@VERSION@",{requires:["flickr-route","flickr-promise","photostream-models","person-preferences-models"],optionalRequires:["hermes-core"],langBundles:["common"]});